#OAuth Integration

Tokenpass uses the OAuth 2.0 protocol for allowing users to sign in and connect to third party applications.  

You can find out more about OAuth 2.0 [here](http://oauth.net/documentation/).

In this guide we will show you how to implement "log in with Tokenpass" for your app. 

Source code for a working demo Laravel application can be found [here](https://github.com/tokenly/tokenpass-demo).

##Step 1: Set up

Prepare your application for API usage.

* Define a public endpoint route for OAuth callback requests (e.g https://my.app.io/account/authorize/callback)
* Generate an API key pair on [https://tokenpass.tokenly.com](https://tokenpass.tokenly.com) (include callback endpoint)
* Add  ```tokenly_uuid``` and ```oauth_token``` fields to your ```users``` table in your local database.

**If using PHP**

* Include the ```tokenly/tokenpass-client``` library in your project.
* If using **laravel**, add ```Tokenly\TokenpassClient\Provider\TokenpassServiceProvider::class``` to your service providers list
and run the command ```php artisan vendor:publish --provider="Tokenly\TokenpassClient\Provider\TokenpassServiceProvider"```.
You will also need to install ```laravel\socialite``` and add Socialite to your facades list.
* Also if using laravel, edit the ```redirect``` field in ```config/tokenpass.php``` as needed.
* Define the following environment (.env) variables: ```TOKENPASS_CLIENT_ID```, ```TOKENPASS_CLIENT_SECRET```, ```SITE_HOST```
* Set the ```TOKENPASS_PROVIDER_HOST``` environment variable to ```https://tokenpass.tokenly.com```.


**Otherwise..**

* Optionally include your favorite OAuth2 helper library.
* Define the API key client ID + secret as constants/environment variables in your application.

##Step 2: Initiate Login

```php
	<?php 
	namespace App\Http\Controllers;
	use Illuminate\Support\Facades\Auth;
	use Redirect, Request, Input, User;
	use Laravel\Socialite\Facades\Socialite;
	use Laravel\Socialite\Two\InvalidStateException;
	use App\Http\Controllers\Controller;
	use Tokenly\TokenpassClient\Facade\Tokenpass;
		
	class AccountController extends Controller {
		public function login()
		{
			if(Auth::user()){
				//already logged in, redirect to home
				return Redirect::route('account.home');
			}
			//else redirect to oauth provider
			return Socialite::redirect();
		}
		
		
		.....
	}

```

Create the login route in your app and redirect to Tokenpass to start the OAuth process if the user is not already signed in. 

**Redirect to Tokenpass Authorization:**

Redirect the user to https://tokenpass.tokenly.com/oauth/authorize with the following [url encoded] query parameters:

* ```client_id```  - your application client ID (API key)
* ```redirect_uri``` - URL to send user back to upon successful authorization (must match a callback endpoint in API client settings)
* ```scope``` - comma separated list of permission scopes your application is requesting
* ```response_type=code```
* ```state``` - randomized string generated by your application and saved in the users' session for callback validation

If you are using PHP+Laravel, the ```Socialite``` class can handle this for you.

After logging in, users are presented with a grant/deny permissions screen which looks like this:

![](/images/tokenpass-auth.jpg)


##Step 3: Implement Callback Endpoint

```php
	<?php
    public function handleTokenpassCallback(Request $request)
    {
        try {
            // check for an error returned from Tokenly Accounts
            $error_description = Tokenpass::checkForError($request);
            if ($error_description) {
                return view('account.authorization-failed', ['error_msg' => $error_description]);
            }
			
            // retrieve the user from Tokenly Accounts
            $oauth_user = Socialite::user();
            
            
            // get all the properties from the oAuth user object
            $tokenly_uuid       = $oauth_user->id;
            $oauth_token        = $oauth_user->token;
            $username           = $oauth_user->user['username'];
            $name               = $oauth_user->user['name'];
            $email              = $oauth_user->user['email'];
            
            // find an existing user based on the credentials provided
            $existing_user = User::where('tokenly_uuid', $tokenly_uuid)->first();
            
            // if an existing user wasn't found, we might need to find a user to merge into
            $mergable_user = ($existing_user ? null : User::where('username', $username)->orWhere('email', $email)->where('tokenly_uuid', null)->first());
            
            $used_user = false;
            if ($existing_user) {
                // update the user
                $existing_user->update(['oauth_token' => $oauth_token, 'name' => $name, 'email' => $email, 
										'tokenly_uuid' => $tokenly_uuid, 'username' => $username ]);
                $used_user = $existing_user;
                
            } else if ($mergable_user) {
                // an existing user was found with a matching username
                if ($mergable_user['tokenly_uuid']) {
                    throw new Exception("Can't merge a user already associated with a different tokenpass account", 1);
                }
                // update if needed
                $mergable_user->update(['name' => $name, 'email' => $email, 'oauth_token' => $oauth_token,
										'username' => $username, 'tokenly_uuid' => $tokenly_uuid]);
                $used_user = $mergable_user;

            } else {
                // no user was found - create a new user based on the information we received
                $create_data = ['tokenly_uuid' => $tokenly_uuid, 'oauth_token' => $oauth_token, 'name' => $name, 'username' => $username, 'email' => $email ];
                $new_user = User::create($create_data);
                $used_user = $new_user;
            }
            Auth::login($used_user);
            return redirect('/account/login');

        } catch (Exception $e) {
            // some unexpected error happened
            return view('account.authorization-failed', ['error_msg' => 'Failed to authenticate this user.']);
        }
    }	
```

After selecting either Grant or Deny, the user is automatically redirected to your OAuth callback endpoint URL. 
Here you verify the request, call back to Tokenpass one more time to receive the ```oauth_token```, then save or update user details and complete the login process.

* Check if the ```error``` query parameter is present indicating a failed authorization. The most common
error received is ```access_denied```. 
* Verify that the ```state``` received query parameter matches the current user session
* Use the ```code``` query parameter to retrieve the actual ```oauth_token```

**Requesting OAuth Token**

Within your application, make a **POST** request to https://tokenpass.tokenly.com/oauth/access-token with the following parameters:

* ```grant_type=authorization_code```
* ```code``` - temporary auth code received in your query parameters
* ```client_id``` - your public API key
* ```client_secret``` - your API secret
* ```redirect_uri``` - callback endpoint URL (must match client API settings), typically the same as used in previous requests

Tokenpass will return a JSON object containing the ```access_token``` field, which is your ```oauth_token```.

**Saving User Info**

Once the ```oauth_token``` is received, you can obtain information on the logged-in user such as their username and email address.

Make a GET request to https://tokenpass.tokenly.com/oauth/user with the ```access_token``` query parameter. The variables returned are:

| Field              | Type     | Description                                      |
|--------------------|----------|--------------------------------------------------|
| id                 | string   | Save this as your ```tokenly_uuid```             |
| username           | string   | Their username                                   |
| email              | string   | Their email address                              |
| name               | string   | Optional real name of user                       |
| email_is_confirmed | boolean  | True if they have verified their email address   |

Make sure to look at the ```email_is_confirmed``` variable to check that the logged-in user is a verified account.

If everything checks out, the user can be considered logged in and granted access to your application.

##Permission Scopes

The following permission scopes are available for use:

| Scope            | Description                                                                                         |
|------------------|-----------------------------------------------------------------------------------------------------|
| user             | Basic user info required for most applications                                                      |
| tca              | Able to make Token Controlled Access requests relating to this user                                 |
| private-address  | Able to view all bitcoin addresses associated with this users' account including non-public ones    |
| manage-address   | Permission to manage this users' verified bitcoin addresses via API                                          |
